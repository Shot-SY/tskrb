<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEVEN KNIGHTS RE:BIRTH</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CHQ2JPN68G"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-CHQ2JPN68G');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.1/tsparticles.bundle.min.js"></script>
	<style>
	    body { font-family: 'Roboto', sans-serif; background-color: #121212; max-width: 1200px; margin: 0 auto; padding: 30px 20px; color: #e0e0e0; position: relative; overflow-y: scroll; }
        body.modal-open { overflow: hidden; }
        body.advanced-search-active > *:not(#results):not(#advancedSearchBtn):not(#tsparticles):not(#loader):not(#copyMessage):not([id*="Popup"]) { filter: blur(8px) brightness(0.4); pointer-events: none; transition: filter 0.3s ease; }
        body.advanced-search-active #results { opacity: 1 !important; }
	    h1 { text-align: center; margin-bottom: 30px; font-family: 'Poppins', sans-serif; font-size: 2.5em; color: #ff4081; text-shadow: 2px 2px 4px rgba(255,255,255,0.2); position: relative; z-index: 1; }
	    .character-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px,1fr)); gap: 20px; margin-bottom: 30px; position: relative; z-index: 1; transform: translateZ(0); }
	    .character-box { background: rgba(26,26,26,0.2); border: none; padding: 15px; text-align: center; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s, background-color 0.3s, z-index 0s 0.3s, filter 0.3s; position: relative; height: 135px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 1; transform: translateZ(0); }
        .character-box.rare, .adv-char-box.rare { border: 2px solid #ff9800; box-shadow: 0 0 15px rgba(255,152,0,0.5); }
        .character-box.super-rare, .adv-char-box.super-rare { border: 2px solid #D32F2F; box-shadow: 0 0 15px rgba(211, 47, 47, 0.5); }
        .character-box.legendary-item, .adv-char-box.legendary-item { border: 2px solid #D4AF37; box-shadow: 0 0 15px rgba(212, 175, 55, 0.6); }
        .extras-character-border, .adv-char-box.extras-character-border { border: 2px solid #b0b0b0; box-shadow: 0 0 10px rgba(176, 176, 176, 0.3); }
	    .character-box.selected { background-color: rgba(255,64,129,0.9); box-shadow: 0 0 20px rgba(255,64,129,0.7), 0 8px 20px rgba(255,64,129,0.8); transform: translateY(-5px); z-index: 2; }
	    @media (hover: hover) and (pointer: fine) {
	        .character-box:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(255,255,255,0.2); z-index: 10; transition: transform 0.3s, box-shadow 0.3s; }
	        .result-item:hover { background: linear-gradient(135deg, #33363d, #2a2c30); box-shadow: 0 6px 25px rgba(0,0,0,0.7), 0 0 10px rgba(255, 64, 129, 0.4); transform: translateY(-3px); border-color: rgba(255, 64, 129, 0.5); }
			.result-item:hover::before { opacity: 1; }
			.extras-box:hover { background: rgba(176, 176, 176, 0.2); border-color: rgba(176, 176, 176, 0.8); }
	    }
	    .character-img { width: 80px; height: 90px; object-fit: cover; margin-bottom: 10px; border-radius: 10px; transition: transform 0.3s; transform: translateZ(0); backface-visibility: hidden; }
	    .character-name { font-size: 16px; margin-bottom: 10px; font-weight: 700; color: #fff; }
	    .spinbox-container { width: 80%; visibility: hidden; opacity: 0; transition: visibility 0.3s, opacity 0.3s, transform 0.3s; justify-content: center; margin-top: -5px; transform: translateY(-10px); }
	    .character-box.selected .spinbox-container { visibility: visible; opacity: 1; transform: translateY(0); }
	    .spinbox-container input[type="number"] { width: 50px; padding: 5px; border: 1px solid #555; border-radius: 8px; text-align: center; font-size: 14px; background-color: #1e1e1e; color: #e0e0e0; transition: border-color 0.3s, box-shadow 0.3s; }
	    .spinbox-container input[type="number"]:focus { border-color: #ff4081; box-shadow: 0 0 5px rgba(255,64,129,0.5); outline: none; background-color: #2a2a2a; }
	    #filterButton { display: flex; align-items: center; justify-content: center; width: 100%; padding: 15px; margin: 25px 0 15px 0; font-size: 18px; cursor: pointer; background: linear-gradient(45deg, #ff4081, #f50057); color: #fff; border: none; border-radius: 30px; box-shadow: 0 4px 16px rgba(255,64,129,0.6); transition: all 0.3s; font-family: 'Poppins', sans-serif; font-weight: 600; position: relative; z-index: 1; transform: translateZ(0); }
	    #filterButton:hover { background: linear-gradient(45deg, #ff4081, #f50057); box-shadow: 0 6px 20px rgba(255,64,129,0.8); transform: translateY(-3px); }
	    #filterButton:active { transform: translateY(0); box-shadow: 0 4px 16px rgba(255,64,129,0.6); }
		#advancedSearchBtn { display: flex; align-items: center; justify-content: center; width: 100%; padding: 15px; margin-bottom: 25px; font-size: 18px; cursor: pointer; color: #fff; background: #1a1a1a; border: 2px solid #ff4081; border-radius: 30px; box-shadow: 0 0 10px rgba(255, 64, 129, 0.6), 0 0 20px rgba(255, 64, 129, 0.4), inset 0 0 5px rgba(255, 64, 129, 0.3); transition: all 0.3s ease; font-family: 'Poppins', sans-serif; font-weight: 600; position: relative; z-index: 1; }
		#advancedSearchBtn:hover { box-shadow: 0 0 15px rgba(255, 64, 129, 0.9), 0 0 30px rgba(255, 64, 129, 0.7), inset 0 0 8px rgba(255, 64, 129, 0.5); transform: translateY(-3px); border-color: #ff80ab; }
		#advancedSearchBtn.exit-mode { background: linear-gradient(45deg, #616161, #757575); border-color: #9E9E9E; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4); z-index: 3001; }
	    #copyInstruction { margin-bottom: 15px; font-style: italic; color: #ff4081; text-align: center; font-size: 1.2em; font-weight: 600; position: relative; z-index: 1; }
	    #copyMessage { position: fixed; top: 50%; left: 50%; --copy-translate-y: -50%; transform: translate(-50%, var(--copy-translate-y)) scale(0.8); background: linear-gradient(135deg, #232526 0%, #414345 100%); color: #fff; padding: 20px 30px; border-radius: 12px; display: none; opacity: 0; font-family: 'Poppins', sans-serif; font-size: 1.1em; box-shadow: 0 8px 32px rgba(0,0,0,0.5); z-index: 5000; transition: opacity 0.3s ease, transform 0.3s ease; border-left: 4px solid #ff4081; will-change: transform, opacity; }
	    #copyMessage.show { display: flex; align-items: center; gap: 15px; animation: messagePop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
	    @keyframes messagePop { 0% { opacity: 0; transform: translate(-50%, var(--copy-translate-y)) scale(0.8); } 50% { opacity: 1; transform: translate(-50%, var(--copy-translate-y)) scale(1.05); } 100% { opacity: 1; transform: translate(-50%, var(--copy-translate-y)) scale(1); } }
	    .copy-icon { width: 24px; height: 24px; background-color: #ff4081; border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: pulse 1s infinite; transform: translateZ(0); }
	    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 64, 129, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 64, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 64, 129, 0); } }
	    .copy-icon svg { width: 14px; height: 14px; fill: white; transform: translateZ(0); }
		#results { padding: 20px; height: 800px; max-height: 800px; overflow-y: auto; background-color: rgba(20,20,20,0.8); border-radius: 15px; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); position: relative; z-index: 1; will-change: scroll-position; -webkit-overflow-scrolling: touch; transform: translateZ(0); transition: opacity 0.2s ease-in-out, filter 0.3s ease; }
        #results.sorting { opacity: 0; }
	    #results .content-container { transform: translateZ(0); will-change: opacity; transition: opacity 0.2s ease; contain: layout paint style; backface-visibility: hidden; }
	    #results.scrolling .result-item { transition: none !important; }
		.result-item { margin-bottom: 18px; padding: 14px 24px; background: linear-gradient(135deg, #202228, #1a1c20); cursor: pointer; transition: background 0.3s, box-shadow 0.3s, transform 0.2s; border-radius: 14px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 20px rgba(0,0,0,0.5), inset 0 1px 2px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: space-between; flex-wrap: nowrap; gap: 18px; position: relative; overflow: hidden; }
		.result-item::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: linear-gradient(180deg, #ff4081, #f50057); opacity: 0.6; transition: opacity 0.3s; }
        .item-images-wrapper { flex-grow: 1; position: relative; overflow: hidden; display: flex; }
		.item-images { display: flex; align-items: center; flex-wrap: nowrap; gap: 10px; overflow-x: auto; padding: 6px; scrollbar-width: none; }
        .item-images::-webkit-scrollbar { display: none; }
		.result-info-right { display: flex; align-items: center; flex-wrap: nowrap; gap: 10px; justify-content: flex-end; flex-shrink: 0; }
	    .small-character-img, .detail-popup-img { transition: filter 0.3s, opacity 0.3s, transform 0.2s; }
		.small-character-img { height: 60px; width: auto; min-width: 45px; object-fit: contain; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1); flex-shrink: 0; }
		.detail-popup-img { height: 55px; width: auto; object-fit: contain; border-radius: 8px; }
		.small-character-img.dimmed, .extras-box.dimmed, .detail-popup-img.dimmed { filter: grayscale(65%); opacity: 0.7; }
		.extras-box { display: flex; justify-content: center; align-items: center; height: 60px; min-width: 84px; padding: 0 12px; background: rgba(176, 176, 176, 0.1); border: 1px dashed rgba(176, 176, 176, 0.5); border-radius: 10px; cursor: pointer; transition: background 0.2s, border-color 0.2s, filter 0.3s, opacity 0.3s; flex-shrink: 0; }
	    .small-character-img.rare, .detail-popup-img.rare { border: 2px solid #ff9800; }
	    .small-character-img.super-rare, .detail-popup-img.super-rare { border: 2px solid #D32F2F; }
        .small-character-img.legendary-item, .detail-popup-img.legendary-item { border: 2px solid #D4AF37; }
        .detail-popup-img.extras-character-border { border: 2px solid #b0b0b0; }
	    body::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: url('https://www.transparenttextures.com/patterns/dark-matter.png') repeat; opacity: 0.1; z-index: -1; }
	    .character-box::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: url('https://www.transparenttextures.com/patterns/gplay.png') repeat; opacity: 0.5; border-radius: 15px; pointer-events: none; z-index: 0; }
	    .character-box > * { position: relative; z-index: 1; }
        .image-with-count-container { position: relative; display: inline-block; vertical-align: middle; flex-shrink: 0; }
		.image-count-badge { position: absolute; bottom: -5px; right: -5px; min-width: 22px; text-align: center; background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); color: #fff; padding: 2px 7px; border-radius: 10px; font-family: 'Poppins', sans-serif; font-size: 15px; font-weight: 600; line-height: 1.4; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 2px 5px rgba(0,0,0,0.6); pointer-events: none; }
		.image-count-badge.rare-badge { color: #ffc107; text-shadow: 0 0 5px rgba(255, 193, 7, 0.7); }
		.image-count-badge.super-rare-badge { color: #ff5252; text-shadow: 0 0 5px rgba(255, 82, 82, 0.7); }
        .image-count-badge.legendary-badge { color: #FFD700; text-shadow: 0 0 5px rgba(255, 215, 0, 0.8); }
		.price-box { display: flex; flex-direction: column; justify-content: center; align-items: flex-end; height: 60px; min-width: 114px; padding: 0 12px; background: linear-gradient(270deg, rgba(39, 174, 96, 0.2), transparent); border-radius: 10px; font-family: 'Poppins', sans-serif; }
		.price-box .price-usd { font-size: 22px; font-weight: 700; color: #2ecc71; text-shadow: 0 0 8px rgba(46, 204, 113, 0.5); }
		.price-box .price-krw { font-size: 14px; color: #bdc3c7; }
		.target-total-box { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 60px; min-width: 100px; padding: 0 12px; background: linear-gradient(270deg, rgba(41, 121, 255, 0.2), transparent); border-radius: 10px; font-family: 'Poppins', sans-serif; }
		.target-total-label { font-size: 14px; color: #bdc3c7; }
		.target-total-value { font-size: 22px; font-weight: 700; color: #448AFF; text-shadow: 0 0 8px rgba(68, 138, 255, 0.6); }
	    .sort-container { display: flex; justify-content: flex-end; margin-bottom: 15px; padding-right: 5px; transition: all 0.3s; }
	    #sortDropdown { background-color: #2a2c30; color: #e0e0e0; border: 1px solid #555; padding: 8px 12px; border-radius: 8px; font-family: 'Poppins', sans-serif; font-size: 14px; cursor: pointer; outline: none; transition: border-color 0.3s, box-shadow 0.3s; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e0e0e0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 12px center; background-size: 1em; padding-right: 35px; }
	    #sortDropdown:focus, #sortDropdown:hover { border-color: #555; outline: none; box-shadow: none; }
	    #tsparticles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
		.scroll-indicator { position: absolute; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; background: linear-gradient(135deg, rgba(40,40,40,0.8), rgba(20,20,20,0.8)); backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); color: #fff; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 24px; line-height: 28px; font-weight: bold; cursor: pointer; z-index: 10; transition: opacity 0.2s; text-shadow: 0 0 4px rgba(0,0,0,0.5); user-select: none; }
        .scroll-indicator.visible { display: flex; }
        .scroll-indicator-left { left: 5px; }
        .scroll-indicator-right { right: 5px; }
        .item-images-wrapper.has-scroll::before, .item-images-wrapper.has-scroll::after { content: ''; position: absolute; top: 0; width: 70px; height: 100%; pointer-events: none; z-index: 5; transition: opacity 0.3s; opacity: 0; }
        .item-images-wrapper.has-scroll::before { left: 0; background: linear-gradient(to left, rgba(26, 28, 32, 0), #1a1c20 80%); }
        .item-images-wrapper.has-scroll::after { right: 0; background: linear-gradient(to right, rgba(26, 28, 32, 0), #1a1c20 80%); }
        .item-images-wrapper.scrolled-from-start::before { opacity: 1; }
        .item-images-wrapper:not(.scrolled-to-end)::after { opacity: 1; }
	    #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(18,18,18,0.95); display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 2000; transition: opacity 0.5s ease, visibility 0.5s ease; }
	    #loader.hidden { opacity: 0; visibility: hidden; }
	    .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #ff4081; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin-bottom: 20px; transform: translateZ(0); }
	    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
		#extrasPopup, #itemDetailPopup { display: none; position: fixed; z-index: 4000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
		.extras-popup-content, .item-detail-popup-content { background-color: #1e1e1e; padding: 25px; border: 1px solid #555; border-radius: 15px; width: 90%; max-width: 800px; box-shadow: 0 5px 25px rgba(0,0,0,0.7); position: relative; }
        .item-detail-popup-content { max-height: 67vh; display: flex; flex-direction: column; }
		.close-button { color: #aaa; position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; z-index: 10; }
		.close-button:hover, .close-button:focus { color: #fff; }
		#extras-popup-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding-top: 10px; }
        #item-detail-popup-grid { overflow-y: auto; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; padding: 20px 10px 20px; margin-top: 10px; scrollbar-width: thin; scrollbar-color: #ff4081 #1e1e1e; }
        #item-detail-popup-grid::-webkit-scrollbar, #advanced-search-grid::-webkit-scrollbar { width: 8px; }
        #item-detail-popup-grid::-webkit-scrollbar-track, #advanced-search-grid::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.3); border-radius: 10px; }
        #item-detail-popup-grid::-webkit-scrollbar-thumb, #advanced-search-grid::-webkit-scrollbar-thumb { background-color: #ff4081; border-radius: 10px; border: 2px solid #1e1e1e; }
        #item-detail-popup-grid::-webkit-scrollbar-thumb:hover, #advanced-search-grid::-webkit-scrollbar-thumb:hover { background-color: #f50057; }
        .item-detail-popup-footer { margin-top: 15px; padding-top: 15px; border-top: 1px solid #444; display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 15px; text-align: center; }
        .popup-info-box { font-family: 'Poppins', sans-serif; flex: 1; }
        .footer-label { font-size: 14px; color: #bdc3c7; }
        .footer-value { font-size: 22px; font-weight: 700; margin-bottom: 4px; }
        #popup-total-count-value { color: #ff9800; text-shadow: 0 0 8px rgba(255, 152, 0, 0.6); }
        #popup-ruby-info-value { color: #ff5252; text-shadow: 0 0 8px rgba(255, 82, 82, 0.6); }
        #popup-price-usd { font-size: 22px; font-weight: 700; color: #2ecc71; text-shadow: 0 0 8px rgba(46, 204, 113, 0.5); margin-bottom: 4px; }
        #popup-price-krw { font-size: 14px; color: #bdc3c7; }
		#screenOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 3000; opacity: 0; transition: opacity 0.3s ease-in-out; }
		#screenOverlay.visible { display: block; opacity: 1; }
		#advancedSearchModal { display: none; position: fixed; z-index: 4000; left: 50%; top: 50%; transform: translate(-50%, -50%) scale(0.95); width: 90%; max-width: 900px; opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease; }
		#advancedSearchModal.visible { display: block; opacity: 1; transform: translate(-50%, -50%) scale(1); }
		.advanced-search-content { background-color: #1e1e1e; padding: 25px; border: 1px solid #555; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.7); display: flex; flex-direction: column; max-height: 85vh; }
		.advanced-search-header h2 { margin-top: 0; margin-bottom: 10px; color: #448AFF; font-family: 'Poppins', sans-serif; }
		.advanced-search-header p { margin-top: 0; margin-bottom: 20px; line-height: 1.6; color: #bdc3c7; font-size: 15px; }
		#advanced-search-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 15px; overflow-y: auto; padding: 10px; margin: 0 -10px 20px; flex-grow: 1; }
		/* --- MODIFIED --- Advanced Search Box Styles */
		.adv-char-box {
			cursor: pointer;
			border-radius: 10px;
			position: relative;
			background-color: rgba(26,26,26,0.2);
			backdrop-filter: blur(5px);
			transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, background-color 0.2s ease-out;
			display: flex;
			flex-direction: column;
			align-items: center;
			padding: 10px 5px;
		}
		.adv-char-box .character-img {
			width: 60px;
			height: 70px;
			margin-bottom: 8px;
			border-radius: 8px;
		}
		.adv-char-name { font-size: 13px; font-weight: 600; color: #fff; text-align: center; }
		.adv-char-box:hover { transform: scale(1.05); }
		.adv-char-box.selected {
			background-color: rgba(255, 64, 129, 0.9);
			box-shadow: 0 0 20px rgba(255, 64, 129, 0.7), 0 4px 10px rgba(255, 64, 129, 0.5);
			transform: translateY(-5px);
			z-index: 2;
		}
		.advanced-search-footer { display: flex; justify-content: flex-end; gap: 15px; padding-top: 20px; border-top: 1px solid #444; }
		.adv-search-btn { padding: 10px 25px; font-size: 16px; border-radius: 20px; border: none; cursor: pointer; font-family: 'Poppins', sans-serif; font-weight: 600; transition: all 0.2s; }
		#adv-search-execute { background-color: #2979FF; color: white; }
		#adv-search-execute:hover { background-color: #448AFF; }
		#adv-search-reset { background-color: #424242; color: #e0e0e0; }
		#adv-search-reset:hover { background-color: #616161; }
        .new-character-placeholder { display: flex; align-items: center; justify-content: center; font-weight: 700; font-family: 'Poppins', sans-serif; border-radius: 10px; background-color: rgba(0, 0, 0, 0.3); box-sizing: border-box; text-transform: uppercase; }
        .adv-char-box.super-rare .new-character-placeholder { color: #ff5252; text-shadow: 0 0 8px rgba(255, 82, 82, 0.7); box-shadow: inset 0 0 10px rgba(211, 47, 47, 0.5); }
        .adv-char-box.rare .new-character-placeholder { color: #ffc107; text-shadow: 0 0 8px rgba(255, 193, 7, 0.7); box-shadow: inset 0 0 10px rgba(255, 152, 0, 0.5); }
        .adv-char-box.legendary-item .new-character-placeholder { color: #FFD700; text-shadow: 0 0 8px rgba(255, 215, 0, 0.8); box-shadow: inset 0 0 10px rgba(212, 175, 55, 0.6); }
        .adv-char-box.extras-character-border .new-character-placeholder { color: #e0e0e0; text-shadow: 0 0 5px rgba(224, 224, 224, 0.5); box-shadow: inset 0 0 8px rgba(176, 176, 176, 0.3); }
        .character-box .new-character-placeholder { width: 80px; height: 90px; font-size: 22px; margin-bottom: 10px; }
        .adv-char-box .new-character-placeholder { width: 60px; height: 70px; margin-bottom: 8px; font-size: 16px; }
        .image-with-count-container .new-character-placeholder { height: 60px; width: 45px; min-width: 45px; font-size: 14px; }
        #extras-popup-grid .new-character-placeholder { height: 60px; width: 45px; font-size: 14px; }
        #item-detail-popup-grid .new-character-placeholder { height: 55px; width: 45px; font-size: 12px; }
	    @media (max-width: 768px) {
			.character-grid { grid-template-columns: repeat(auto-fill, minmax(80px,1fr)); gap: 10px; }
	        .character-box { height: 125px; padding: 8px; }
	        .character-box .character-img, .character-box .new-character-placeholder { width: 60px; height: 70px; margin-bottom: 5px; }
	        .character-box .character-name { font-size: 14px; }
	        .spinbox-container input[type="number"] { width: 45px; }
	        #filterButton, #advancedSearchBtn { font-size: 16px; padding: 12px; }
	        .result-item { padding: 12px; flex-wrap: wrap; }
            .item-images-wrapper, .result-info-right { flex-basis: 100%; }
			.result-info-right { justify-content: flex-end; }
			.price-box { flex-grow: 1; align-items: center; background: rgba(39, 174, 96, 0.1); min-width: 0; }
			.small-character-img, .extras-box, .price-box, .image-with-count-container .new-character-placeholder { height: 54px; }
	        .item-images { gap: 6px; }
			.scroll-indicator { display: none !important; }
            .item-images-wrapper.has-scroll::before, .item-images-wrapper.has-scroll::after { width: 60px; }
	        #copyInstruction { font-size: 1em; }
	        #copyMessage { font-size: 1em; padding: 15px 20px; }
			.extras-box .item-title { font-size: 12px; }
			.price-box .price-usd { font-size: 19px; }
			.price-box .price-krw { font-size: 12px; }
			.target-total-box { min-width: 80px; }
			.target-total-value { font-size: 19px; }
			.target-total-label { font-size: 12px; }
			.extras-popup-content, .item-detail-popup-content, .advanced-search-content { width: 95%; padding: 15px; }
            #item-detail-popup-grid { gap: 5px; padding: 15px 5px 15px; }
            .detail-popup-img, #item-detail-popup-grid .new-character-placeholder { height: 45px; }
            .item-detail-popup-footer { gap: 10px; }
            .footer-label { font-size: 12px; }
            .footer-value, #popup-price-usd { font-size: 18px; }
            #popup-price-krw { font-size: 12px; }
			#advanced-search-grid { grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; }
			.adv-char-box .character-img, .adv-char-box .new-character-placeholder { width: 50px; height: 60px; }
			.adv-char-name { font-size: 12px; }
			#results {
                height: 75vh;
                max-height: 75vh;
            }
	    }
	</style>
</head>
<body>
    <div id="loader"><div class="spinner"></div></div>
    <div id="tsparticles"></div>
    <h1>SEVEN KNIGHTS RE:BIRTH</h1>
    <div class="character-grid" id="characterGrid"></div>
    <button id="filterButton">Apply Filter</button>
	<button id="advancedSearchBtn">Advanced Search</button>
	<div id="copyInstruction">※ Click item to copy</div>
    <div class="sort-container">
        <select id="sortDropdown">
            <option value="price-high" selected>Price High</option>
            <option value="price-low">Price Low</option>
        </select>
    </div>
    <div id="results"></div>
    <div id="copyMessage"><div class="copy-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div><span>Copied</span></div>
	<div id="screenOverlay"></div>
	<div id="advancedSearchModal">
		<div class="advanced-search-content">
			<div class="advanced-search-header">
				<h2>Find Optimal account</h2>
				<p>This tool scores and ranks accounts based on the total quantity of your selected characters. An account will still appear in the results even if it contains zero of some characters you've selected. Simply pick all characters you find valuable.</p>
			</div>
			<div id="advanced-search-grid"></div>
			<div class="advanced-search-footer">
				<button class="adv-search-btn" id="adv-search-reset">Reset</button>
				<button class="adv-search-btn" id="adv-search-execute">Search</button>
			</div>
		</div>
	</div>
	<div id="extrasPopup"><div class="extras-popup-content"><span class="close-button" id="closeExtrasPopup">×</span><div id="extras-popup-grid"></div></div></div>
    <div id="itemDetailPopup">
        <div class="item-detail-popup-content">
            <span class="close-button" id="closeItemDetailPopup">×</span>
            <div id="item-detail-popup-grid"></div>
            <div class="item-detail-popup-footer">
                <div class="popup-info-box"><div class="footer-value" id="popup-total-count-value"></div><div class="footer-label">Items</div></div>
                <div class="popup-info-box"><div class="footer-value" id="popup-ruby-info-value"></div><div class="footer-label">Ruby</div></div>
                <div class="popup-info-box"><div id="popup-price-usd"></div><div id="popup-price-krw"></div></div>
            </div>
        </div>
    </div>

    <script>
        let isAdvancedSearchMode = false;
        let advancedSearchSelection = null;

        function handleImageError(imgElement) { /* ... same as before ... */ }
        
        // --- SCRIPT START (Full, readable version) ---
        let lastActivityTime = Date.now();
        const updateActivityTime = () => { lastActivityTime = Date.now(); };
        ['click', 'touchstart', 'scroll', 'keypress'].forEach(event => document.addEventListener(event, updateActivityTime));
        document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') { const currentTime = Date.now(); const inactiveTime = currentTime - lastActivityTime; if (inactiveTime > 7200000) { window.location.reload(true); } else { lastActivityTime = currentTime; } } });

        window.addEventListener('load', () => {
            const lastLoad = localStorage.getItem('lastLoadTime'); const currentTime = Date.now();
            if (!lastLoad || (currentTime - parseInt(lastLoad)) > 15000) { localStorage.setItem('lastLoadTime', currentTime); window.location.reload(true); return; }
            const loader = document.getElementById('loader');
            loadCharacters().then(() => loadData()).then(() => applyFiltersAndSort()).then(() => new Promise(r => setTimeout(r, 500)))
                .then(() => {
                    loader.classList.add('hidden');
                    setTimeout(() => {
                        loader.style.display = 'none';
                        const results = document.getElementById('results');
                        if (results) {
                            results.style.willChange = 'scroll-position'; results.style.webkitOverflowScrolling = 'touch';
                            results.addEventListener('scroll', function() { if (!results.isScrolling) { results.isScrolling = true; results.classList.add('scrolling'); } clearTimeout(results.scrollEndTimer); results.scrollEndTimer = setTimeout(function() { results.isScrolling = false; results.classList.remove('scrolling'); }, 100); }, { passive: true });
                        }
                        optimizeImages(); optimizeParticles();
                    }, 500);
                })
                .catch(error => { console.error('Initial filter application error:', error); loader.classList.add('hidden'); setTimeout(() => loader.style.display = 'none', 500); });
        });

        function optimizeParticles() {
            const pauseParticles = () => window.tsParticles?.domItem(0)?.pause(); const resumeParticles = () => window.tsParticles?.domItem(0)?.play();
            const results = document.getElementById('results');
            if (results) { results.addEventListener('scroll', () => { if (!results.particlesPaused) { pauseParticles(); results.particlesPaused = true; clearTimeout(results.particlesTimer); results.particlesTimer = setTimeout(() => { resumeParticles(); results.particlesPaused = false; }, 200); } }, { passive: true }); }
            document.addEventListener('visibilitychange', () => { document.visibilityState === 'hidden' ? pauseParticles() : resumeParticles(); });
        }
        
        let characters = []; let tier0Characters = []; let tier1Characters = []; let tier2Characters = []; let currentFilteredData = {}; let itemObserver;

		function loadCharacters() {
            const ts = new Date().getTime();
            return fetch(`Characters.txt?t=${ts}`).then(r => r.text()).then(text => {
                const lines = text.split('\n'); let currentTier = 0;
                lines.forEach(line => {
                    const trimmedLine = line.trim(); if (trimmedLine === '') { currentTier++; return; }
                    const parts = trimmedLine.split(' ');
                    if (parts.length >= 2) { const [eng, ...korParts] = parts; const kor = korParts.join(' '); const charData = [eng, kor]; if (currentTier === 0) tier0Characters.push(charData); else if (currentTier === 1) tier1Characters.push(charData); else if (currentTier === 2) tier2Characters.push(charData); }
                });
                characters = [...tier0Characters, ...tier1Characters, ...tier2Characters]; createCharacterBoxes(); populateAdvancedSearchGrid();
            }).catch(error => console.error('Character data loading error:', error));
        }

        let luaData = {};

        function createCharacterBoxes() {
            const grid = document.getElementById('characterGrid'); grid.innerHTML = ''; const fragment = document.createDocumentFragment();
            const tier0Eng = new Set(tier0Characters.map(([eng]) => eng)); const tier1Eng = new Set(tier1Characters.map(([eng]) => eng));
            characters.forEach(([eng, kor]) => {
                const charBox = document.createElement('div'); charBox.className = 'character-box'; charBox.dataset.engName = eng;
                if (tier0Eng.has(eng)) charBox.classList.add('super-rare'); else if (tier1Eng.has(eng)) charBox.classList.add('rare'); else charBox.classList.add('extras-character-border');
                charBox.innerHTML = `<img src="Portrait/${kor}.png" alt="${kor}" class="character-img" loading="lazy" decoding="async" onerror="handleImageError(this)"><span class="character-name">${eng}</span><div class="spinbox-container"><input type="number" id="${eng}-spin" min="0" max="13" value="0" disabled></div>`;
                charBox.addEventListener('click', (e) => { if (e.target.tagName.toLowerCase() !== 'input') toggleSelection(charBox); });
                charBox.querySelector('input').addEventListener('click', (e) => { e.stopPropagation(); if (!charBox.classList.contains('selected')) toggleSelection(charBox); });
                fragment.appendChild(charBox);
            });
            const teoTsBox = document.createElement('div'); teoTsBox.className = 'character-box legendary-item'; teoTsBox.dataset.engName = 'TeoTS';
            teoTsBox.innerHTML = `<img src="Portrait/태오ts스킨.png" alt="태오 TS 스킨" class="character-img" loading="lazy" decoding="async" onerror="handleImageError(this)"><span class="character-name">Teo TS</span><div class="spinbox-container" style="visibility: hidden;"></div>`;
            teoTsBox.addEventListener('click', () => toggleSelection(teoTsBox));
            let teoBoxNode = Array.from(fragment.children).find(child => child.dataset.engName?.toLowerCase() === 'teo');
            if (teoBoxNode) fragment.insertBefore(teoTsBox, teoBoxNode); else fragment.insertBefore(teoTsBox, fragment.firstChild);
            grid.appendChild(fragment);
        }

        function toggleSelection(charBox) { const spinbox = charBox.querySelector('input[type="number"]'); const isSelected = charBox.classList.toggle('selected'); if (spinbox) { spinbox.disabled = !isSelected; spinbox.value = isSelected ? (spinbox.value === '0' ? '1' : spinbox.value) : 0; } }

        let itemDetailsMap = {};

        function loadData() {
            const ts = new Date().getTime();
            return fetch(`account_prices.txt?t=${ts}`).then(r => r.text()).then(text => {
                luaData = {}; itemDetailsMap = {};
                const lines = text.split('\n');
                lines.forEach(line => {
                    if (!line.trim() || !line.includes('=')) return;
                    const parts = line.split('='); const pricePart = parts.pop().trim(); const contentPart = parts.join('=').trim(); const contentWords = contentPart.split(/\s+/); const key = contentWords.shift();
                    const itemDetails = { originalText: line, price: parseFloat(pricePart.replace('$', '')), costume: line.toLowerCase().includes('[teo legend costume]'), totalCount: 0 };
                    const currentItemChars = {};
                    contentWords.forEach(word => { const match = word.match(/^([a-zA-Z]+)(\d+)$/); if (match) { const charName = match[1].toLowerCase(); const count = parseInt(match[2]); currentItemChars[charName] = (currentItemChars[charName] || 0) + count; } });
                    for (const charName in currentItemChars) { itemDetails.totalCount += currentItemChars[charName]; }
                    if (itemDetails.costume) { itemDetails.totalCount++; }
                    luaData[key] = currentItemChars; itemDetailsMap[key] = itemDetails;
                });
            }).catch(error => console.error('Data loading error:', error));
        }

        function applyFiltersAndSort() {
            const resultsDiv = document.getElementById('results'); resultsDiv.classList.add('sorting'); window.tsParticles?.domItem(0)?.pause();
            setTimeout(() => {
                currentFilteredData = Object.fromEntries(Object.entries(luaData).filter(([k, v]) => checkConditions(v, k)));
                const sortKey = document.getElementById('sortDropdown')?.value || 'price-high';
                const sortedKeys = Object.keys(currentFilteredData).sort((a, b) => {
                    const itemA = itemDetailsMap[a]; const itemB = itemDetailsMap[b];
                    if (sortKey === 'price-low') { return (itemA.price - itemB.price) || (itemB.totalCount - itemA.totalCount); }
                    return (itemB.price - itemA.price) || (itemB.totalCount - itemA.totalCount);
                });
                displayResults({ data: currentFilteredData, sortedKeys });
                resultsDiv.classList.remove('sorting'); window.tsParticles?.domItem(0)?.play();
            }, 200);
        }

        function checkConditions(itemChars, itemKey) {
            const allCharsMatch = characters.every(([eng]) => { const box = document.querySelector(`.character-box[data-eng-name="${eng}"]`); return !box || !box.classList.contains('selected') || (itemChars[eng.toLowerCase()] || 0) >= parseInt(box.querySelector('input').value); });
            if (!allCharsMatch) return false;
            const teoTsBox = document.querySelector('.character-box[data-eng-name="TeoTS"]');
            return !teoTsBox || !teoTsBox.classList.contains('selected') || itemDetailsMap[itemKey].costume;
        }

        function optimizeImages() { document.querySelectorAll('img').forEach(img => { if (!img.hasAttribute('loading')) img.loading = 'lazy'; if (!img.hasAttribute('decoding')) img.decoding = 'async'; }); }
		
		function displayResults({ data, sortedKeys, advancedSearchSelection = null }) {
			const res = document.getElementById('results'); res.scrollTop = 0; const fragment = document.createDocumentFragment(); const container = document.createElement('div'); container.className = 'content-container'; fragment.appendChild(container);
            const tier0Eng = new Set(tier0Characters.map(([eng]) => eng));
			
			sortedKeys.forEach(k => {
				const item = document.createElement('div'); item.className = 'result-item'; item.dataset.itemKey = k;
				item.addEventListener('click', (e) => { if (e.target.closest('.extras-box') || e.target.closest('.scroll-indicator')) return; showItemDetailPopup(k); });
                item.addEventListener('mouseenter', () => resetOtherScrolledItems(item));
                item.addEventListener('mouseleave', () => { const imgContainer = item.querySelector('.item-images-wrapper.has-scroll .item-images'); if (imgContainer && imgContainer.scrollLeft > 0) { imgContainer.scroll({ left: 0, behavior: 'smooth' }); } });
                
                const imagesWrapper = document.createElement('div'); imagesWrapper.className = 'item-images-wrapper'; const imageContainer = document.createElement('div'); imageContainer.className = 'item-images'; const rightSection = document.createElement('div'); rightSection.className = 'result-info-right';
				const charValue = luaData[k]; const itemDetails = itemDetailsMap[k];
                
				if (advancedSearchSelection) {
					let total = 0;
					advancedSearchSelection.forEach(name => { if (name.toLowerCase() === 'teots') { if(itemDetails.costume) total++; } else if (charValue[name.toLowerCase()]) { total += charValue[name.toLowerCase()]; } });
					const scoreBox = document.createElement('div'); scoreBox.className = 'target-total-box';
					scoreBox.innerHTML = `<div class="target-total-label">Target Total</div><div class="target-total-value">${total}</div>`;
					rightSection.prepend(scoreBox);
				}
                let allImportantItemsData = []; const tier2ImageData = [];
                for (const charName in charValue) {
                    const charInfo = characters.find(([eng]) => eng.toLowerCase() === charName); if (!charInfo) continue;
                    const [engName, korName] = charInfo; const originalIndex = characters.findIndex(([eng]) => eng === engName);
                    const imageData = { type: 'character', src: `Portrait/${korName}.png`, alt: korName, engName: engName, count: charValue[charName], originalIndex: originalIndex };
                    if (tier0Characters.some(c => c[0] === engName) || tier1Characters.some(c => c[0] === engName)) { allImportantItemsData.push(imageData); } else { tier2ImageData.push(imageData); }
                }
                allImportantItemsData.sort((a, b) => a.originalIndex - b.originalIndex);
                if (itemDetails.costume) {
                    const teoTsData = { type: 'character', src: 'Portrait/태오ts스킨.png', alt: '태오 TS 스킨', engName: 'TeoTS', count: 1 };
                    const teoIndex = allImportantItemsData.findIndex(item => item.engName.toLowerCase() === 'teo');
                    if (teoIndex !== -1) { allImportantItemsData.splice(teoIndex, 0, teoTsData); } else { allImportantItemsData.unshift(teoTsData); }
                }
                tier2ImageData.sort((a, b) => a.originalIndex - b.originalIndex);
                
                if (allImportantItemsData.length > 0) {
                    const firstItemData = allImportantItemsData[0];
                    const element = createCharacterImageElement(firstItemData, tier0Eng, false, advancedSearchSelection);
                    imageContainer.appendChild(element);
                    const remainingItemsData = allImportantItemsData.slice(1);
                    if (remainingItemsData.length > 0 || tier2ImageData.length > 0) { item.classList.add('lazy-load-item'); item.dataset.remainingItems = JSON.stringify(remainingItemsData); item.dataset.tier2Items = JSON.stringify(tier2ImageData); }
                }
                if (tier2ImageData.length > 0 && allImportantItemsData.length === 0) { item.classList.add('lazy-load-item'); item.dataset.tier2Items = JSON.stringify(tier2ImageData); }
                const priceBox = document.createElement('div'); priceBox.className = 'price-box'; const usdPrice = itemDetails.price.toFixed(2); const krwPriceRounded = Math.round(itemDetails.price * 1400 / 1000) * 1000;
                priceBox.innerHTML = `<div class="price-usd">$${usdPrice}</div><div class="price-krw">₩ ${krwPriceRounded.toLocaleString()}</div>`;
                rightSection.appendChild(priceBox);
                
                const scrollIndicatorLeft = document.createElement('div'); scrollIndicatorLeft.className = 'scroll-indicator scroll-indicator-left'; scrollIndicatorLeft.innerHTML = '‹';
                const scrollIndicatorRight = document.createElement('div'); scrollIndicatorRight.className = 'scroll-indicator scroll-indicator-right'; scrollIndicatorRight.innerHTML = '›';
                imagesWrapper.appendChild(imageContainer); imagesWrapper.appendChild(scrollIndicatorLeft); imagesWrapper.appendChild(scrollIndicatorRight);
				item.appendChild(imagesWrapper); item.appendChild(rightSection);
				container.appendChild(item);
			});
			res.innerHTML = ''; res.appendChild(fragment); document.getElementById('copyInstruction').style.display = 'block';
            document.querySelectorAll('#results .result-item').forEach(item => setupScrollControlsForItem(item, advancedSearchSelection)); setupItemObserver(advancedSearchSelection);
		}

        function createCharacterImageElement(charData, tier0Eng, isLazy = false, advSel = null) {
            const container = document.createElement('div'); container.className = 'image-with-count-container'; if (isLazy) { container.classList.add('js-lazy-loaded'); }
            const img = document.createElement('img'); img.src = charData.src; img.alt = charData.alt; img.className = 'small-character-img'; img.onerror = function() { handleImageError(this); };
			if (advSel && !advSel.includes(charData.engName)) { img.classList.add('dimmed'); }
            const badge = document.createElement('div'); badge.className = 'image-count-badge';
            if (charData.engName === 'TeoTS') { img.classList.add('legendary-item'); badge.classList.add('legendary-badge'); } else { const isTier0 = tier0Eng.has(charData.engName); img.classList.add(isTier0 ? 'super-rare' : 'rare'); badge.classList.add(isTier0 ? 'super-rare-badge' : 'rare-badge'); }
            container.appendChild(img); if (charData.count > 1) { badge.textContent = `x${charData.count}`; container.appendChild(badge); }
            return container;
        }

        function setupItemObserver(advSel = null) {
            if (itemObserver) { itemObserver.disconnect(); }
            itemObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) { clearTimeout(entry.target.revertTimer); entry.target.renderTimer = setTimeout(() => renderFullItem(entry.target, advSel), 100); }
                    else { clearTimeout(entry.target.renderTimer); entry.target.revertTimer = setTimeout(() => revertToLazyItem(entry.target), 100); }
                });
            }, { root: document.getElementById('results'), rootMargin: '400px 0px' });
            document.querySelectorAll('.lazy-load-item').forEach(item => itemObserver.observe(item));
        }
		
        function renderFullItem(item, advSel = null) {
            if (item.querySelector('.js-lazy-loaded')) return;
            const remainingItemsJSON = item.dataset.remainingItems; const tier2ItemsJSON = item.dataset.tier2Items; const imageContainer = item.querySelector('.item-images'); const tier0Eng = new Set(tier0Characters.map(([eng]) => eng));
            if (remainingItemsJSON) {
                const remainingItems = JSON.parse(remainingItemsJSON);
                remainingItems.forEach(itemData => { const element = createCharacterImageElement(itemData, tier0Eng, true, advSel); imageContainer.appendChild(element); });
            }
            if (tier2ItemsJSON) {
                const tier2Items = JSON.parse(tier2ItemsJSON);
                if(tier2Items.length > 0) {
                    const extrasBox = document.createElement('div'); extrasBox.className = 'extras-box js-lazy-loaded'; extrasBox.innerHTML = `<div class="item-title">Extras</div>`;
					if (advSel) { extrasBox.classList.add('dimmed'); }
                    extrasBox.addEventListener('click', (e) => { e.stopPropagation(); showExtrasPopup(tier2Items); });
                    imageContainer.appendChild(extrasBox);
                }
            }
            setupScrollControlsForItem(item, advSel);
        }

        function revertToLazyItem(item) {
            const lazyElements = item.querySelectorAll('.js-lazy-loaded');
            if (lazyElements.length === 0) return;
            lazyElements.forEach(el => el.remove());
            setupScrollControlsForItem(item);
        }
        
        function setupScrollControlsForItem(item, advSel = null) {
            const wrapper = item.querySelector('.item-images-wrapper'); const imagesContainer = item.querySelector('.item-images'); const scrollLeftBtn = item.querySelector('.scroll-indicator-left'); const scrollRightBtn = item.querySelector('.scroll-indicator-right');
            if (!wrapper || !imagesContainer || !scrollLeftBtn || !scrollRightBtn) return;
            requestAnimationFrame(() => {
                const hasScroll = imagesContainer.scrollWidth > imagesContainer.clientWidth;
                wrapper.classList.toggle('has-scroll', hasScroll);
                if (hasScroll) {
                    scrollRightBtn.onclick = (e) => { e.stopPropagation(); imagesContainer.scrollBy({ left: imagesContainer.clientWidth * 0.8, behavior: 'smooth' }); };
                    scrollLeftBtn.onclick = (e) => { e.stopPropagation(); imagesContainer.scrollBy({ left: -imagesContainer.clientWidth * 0.8, behavior: 'smooth' }); };
                    imagesContainer.onscroll = () => {
                        const { scrollLeft, scrollWidth, clientWidth } = imagesContainer; const tolerance = 5;
                        const isAtStart = scrollLeft < tolerance; const isAtEnd = scrollLeft + clientWidth >= scrollWidth - tolerance;
                        scrollLeftBtn.classList.toggle('visible', !isAtStart); scrollRightBtn.classList.toggle('visible', !isAtEnd);
                        wrapper.classList.toggle('scrolled-from-start', !isAtStart); wrapper.classList.toggle('scrolled-to-end', isAtEnd);
                    };
                    imagesContainer.dispatchEvent(new Event('scroll'));
                } else {
                    scrollLeftBtn.classList.remove('visible'); scrollRightBtn.classList.remove('visible'); imagesContainer.onscroll = null;
                }
            });
        }
        
		function resetAllScrolledItems() { document.querySelectorAll('.item-images-wrapper.has-scroll .item-images').forEach(container => { if (container.scrollLeft > 0) { container.scroll({ left: 0, behavior: 'smooth' }); } }); }
        function resetOtherScrolledItems(currentItem) { document.querySelectorAll('.result-item').forEach(item => { if (item !== currentItem) { const container = item.querySelector('.item-images-wrapper.has-scroll .item-images'); if (container && container.scrollLeft > 0) { container.scroll({ left: 0, behavior: 'smooth' }); } } }); }
		function showExtrasPopup(images) { const popup = document.getElementById('extrasPopup'); const grid = document.getElementById('extras-popup-grid'); grid.innerHTML = ''; images.forEach(charData => { const container = document.createElement('div'); container.className = 'image-with-count-container'; container.innerHTML = `<img src="${charData.src}" alt="${charData.alt}" class="small-character-img extras-character-border" loading="lazy" decoding="async" onerror="handleImageError(this)">${charData.count > 1 ? `<div class="image-count-badge">x${charData.count}</div>` : ''}`; grid.appendChild(container); }); popup.style.display = 'flex'; }

        function showItemDetailPopup(itemKey) {
            const popup = document.getElementById('itemDetailPopup'); const grid = document.getElementById('item-detail-popup-grid');
            grid.innerHTML = ''; grid.scrollTop = 0;
            const charValue = luaData[itemKey]; const itemDetails = itemDetailsMap[itemKey]; let allItemsData = [];
            const tier0Eng = new Set(tier0Characters.map(([e]) => e)); const tier1Eng = new Set(tier1Characters.map(([e]) => e));
            for (const charName in charValue) {
                const charInfo = characters.find(([e]) => e.toLowerCase() === charName); if (!charInfo) continue;
                const [engName, korName] = charInfo; const originalIndex = characters.findIndex(([e]) => e === engName);
                allItemsData.push({ src: `Portrait/${korName}.png`, alt: korName, engName, count: charValue[charName], originalIndex });
            }
            if (itemDetails.costume) {
                const teoTsData = { src: 'Portrait/태오ts스킨.png', alt: 'TS', engName: 'TeoTS', count: 1 };
                const teoIndex = allItemsData.findIndex(item => item.engName.toLowerCase() === 'teo');
                if (teoIndex !== -1) allItemsData.splice(teoIndex, 0, teoTsData);
                else allItemsData.unshift(teoTsData);
            }
            allItemsData.sort((a, b) => a.originalIndex - b.originalIndex);
            allItemsData.forEach(charData => {
                for (let i = 0; i < charData.count; i++) {
                    const img = document.createElement('img'); img.src = charData.src; img.alt = charData.alt; img.className = 'detail-popup-img';
                    img.loading = 'lazy'; img.decoding = 'async'; img.onerror = function() { handleImageError(this); };
                    if (isAdvancedSearchMode && advancedSearchSelection && !advancedSearchSelection.includes(charData.engName)) { img.classList.add('dimmed'); }
                    if (charData.engName === 'TeoTS') img.classList.add('legendary-item');
                    else if (tier0Eng.has(charData.engName)) img.classList.add('super-rare');
                    else if (tier1Eng.has(charData.engName)) img.classList.add('rare');
                    else img.classList.add('extras-character-border');
                    grid.appendChild(img);
                }
            });
            document.getElementById('popup-total-count-value').textContent = itemDetails.totalCount; document.getElementById('popup-ruby-info-value').textContent = '220,000+';
            const usdPrice = itemDetails.price.toFixed(2); const krwPriceRounded = Math.round(itemDetails.price * 1400 / 1000) * 1000;
            document.getElementById('popup-price-usd').textContent = `$${usdPrice}`; document.getElementById('popup-price-krw').textContent = `₩ ${krwPriceRounded.toLocaleString()}`;
            popup.style.display = 'flex'; copyToClipboard(itemKey);
        }

        function copyToClipboard(itemKey) { const itemDetails = itemDetailsMap[itemKey]; if (!itemDetails) return; navigator.clipboard.writeText(itemDetails.originalText).then(() => showCopyMessage(), err => console.error('Copy failed: ', err)); }
        function showCopyMessage(){ const msg = document.getElementById('copyMessage'); const popup = document.getElementById('itemDetailPopup'); const popupContent = popup.querySelector('.item-detail-popup-content'); if (popup && popup.style.display === 'flex' && popupContent) { const popupRect = popupContent.getBoundingClientRect(); msg.style.top = `${popupRect.bottom + 15}px`; msg.style.setProperty('--copy-translate-y', '0'); } else { msg.style.top = '50%'; msg.style.setProperty('--copy-translate-y', '-50%'); } msg.classList.add('show'); setTimeout(() => { msg.classList.remove('show'); setTimeout(() => { msg.style.top = ''; msg.style.removeProperty('--copy-translate-y'); }, 300); }, 2000); }

		function populateAdvancedSearchGrid() {
			const grid = document.getElementById('advanced-search-grid'); grid.innerHTML = '';
			const fragment = document.createDocumentFragment();
			const tier0Eng = new Set(tier0Characters.map(([eng]) => eng)); const tier1Eng = new Set(tier1Characters.map(([eng]) => eng));
			characters.forEach(([eng, kor]) => {
				const charBox = document.createElement('div'); charBox.className = 'adv-char-box'; charBox.dataset.engName = eng;
				if (tier0Eng.has(eng)) charBox.classList.add('super-rare'); else if (tier1Eng.has(eng)) charBox.classList.add('rare'); else charBox.classList.add('extras-character-border');
				charBox.innerHTML = `<img src="Portrait/${kor}.png" alt="${kor}" class="character-img" loading="lazy" decoding="async" onerror="handleImageError(this)"><span class="adv-char-name">${eng}</span>`;
				charBox.addEventListener('click', () => charBox.classList.toggle('selected'));
				fragment.appendChild(charBox);
			});
            const teoTsBox = document.createElement('div'); teoTsBox.className = 'adv-char-box legendary-item'; teoTsBox.dataset.engName = 'TeoTS';
            teoTsBox.innerHTML = `<img src="Portrait/태오ts스킨.png" alt="태오 TS 스킨" class="character-img" loading="lazy" decoding="async" onerror="handleImageError(this)"><span class="adv-char-name">Teo TS</span>`;
            teoTsBox.addEventListener('click', () => teoTsBox.classList.toggle('selected'));
            let teoBoxNode = Array.from(fragment.children).find(child => child.dataset.engName?.toLowerCase() === 'teo');
            if (teoBoxNode) fragment.insertBefore(teoTsBox, teoBoxNode); else fragment.insertBefore(teoTsBox, fragment.firstChild);
			grid.appendChild(fragment);
		}

		function openAdvancedSearchModal() { document.getElementById('screenOverlay').classList.add('visible'); document.getElementById('advancedSearchModal').classList.add('visible'); document.body.classList.add('modal-open'); }
		function closeAdvancedSearchModal() { document.getElementById('screenOverlay').classList.remove('visible'); document.getElementById('advancedSearchModal').classList.remove('visible'); document.body.classList.remove('modal-open'); }

		function executeAdvancedSearch() {
			const selectedCharElements = document.querySelectorAll('#advanced-search-grid .adv-char-box.selected');
			if (selectedCharElements.length === 0) { alert('Please select at least one character.'); return; }
			advancedSearchSelection = Array.from(selectedCharElements).map(el => el.dataset.engName);
			closeAdvancedSearchModal();
			isAdvancedSearchMode = true; document.body.classList.add('advanced-search-active');
			const advBtn = document.getElementById('advancedSearchBtn'); advBtn.innerHTML = '↩️ Back'; advBtn.classList.add('exit-mode');
			const analyticsString = 'adv:' + advancedSearchSelection.join(','); gtag('event', 'advanced_search', { 'selected_characters': analyticsString });
            displayAdvancedSearchResults(advancedSearchSelection);
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
		}

		function displayAdvancedSearchResults(selectedChars) {
			const resultsDiv = document.getElementById('results');
            resultsDiv.classList.add('sorting'); 
            window.tsParticles?.domItem(0)?.pause();
			
			setTimeout(() => {
				// 1. luaData의 모든 아이템을 가져와 점수를 계산합니다.
				const scoredItems = Object.keys(luaData).map(key => {
					const itemChars = luaData[key]; 
					const itemDetails = itemDetailsMap[key]; 
					let total = 0;
					selectedChars.forEach(name => {
						if (name.toLowerCase() === 'teots') {
							if (itemDetails.costume) total++;
						} else if (itemChars[name.toLowerCase()]) {
							total += itemChars[name.toLowerCase()];
						}
					});
					return { key, total, price: itemDetails.price };
				});

				// 2. 'total'이 0인 아이템을 필터링하는 코드 없이, 모든 아이템을 정렬합니다.
				const sortedKeys = scoredItems
					.sort((a, b) => {
						// 주 정렬: Target Total이 높은 순서
						if (b.total !== a.total) {
                            return b.total - a.total;
                        }
						// 부 정렬: Target Total이 같으면 가격이 높은 순서
						return b.price - a.price;
					})
					.map(item => item.key);
				
				// 3. 정렬된 전체 키 목록을 사용하여 결과를 표시합니다.
				displayResults({ data: luaData, sortedKeys, advancedSearchSelection: selectedChars });

				resultsDiv.classList.remove('sorting');
				window.tsParticles?.domItem(0)?.play();
			}, 200);
		}

		function exitAdvancedSearchMode() {
			isAdvancedSearchMode = false; advancedSearchSelection = null;
			document.body.classList.remove('advanced-search-active');
			const advBtn = document.getElementById('advancedSearchBtn'); advBtn.innerHTML = 'Advanced Search'; advBtn.classList.remove('exit-mode');
			applyFiltersAndSort();
		}

		function getSelectedCharacters(){
		    return [...document.querySelectorAll('.character-box.selected')]
		        .map(b => {
		            const value = b.querySelector('input')?.value ?? '1';
		            return `${b.dataset.engName}:${value}`;
		        })
		        .join(',');
		}

        const throttle = (func, delay) => { let last = 0; return (...args) => { const now = Date.now(); if (now - last < delay) return; last = now; func(...args); }; };
        const debounce = (func, delay) => { let id; return (...args) => { clearTimeout(id); id = setTimeout(() => func(...args), delay); }; };
		
		const throttledFilterHandler = throttle(() => {
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
            applyFiltersAndSort();
            const selectedCharsString = getSelectedCharacters();
            if (selectedCharsString) {
                gtag('event', 'apply_filter', { 'selected_characters': selectedCharsString });
            }
        }, 300);

        document.getElementById('filterButton').addEventListener('click', throttledFilterHandler);
        document.getElementById('sortDropdown').addEventListener('change', function() { if (!isAdvancedSearchMode) { applyFiltersAndSort(); } this.blur(); });

		document.addEventListener('DOMContentLoaded', () => {
			const advBtn = document.getElementById('advancedSearchBtn');
			advBtn.addEventListener('click', () => { if (isAdvancedSearchMode) exitAdvancedSearchMode(); else openAdvancedSearchModal(); });
			document.getElementById('adv-search-reset').addEventListener('click', () => { document.querySelectorAll('#advanced-search-grid .adv-char-box.selected').forEach(box => box.classList.remove('selected')); });
			document.getElementById('adv-search-execute').addEventListener('click', executeAdvancedSearch);
			const extrasPopup = document.getElementById('extrasPopup'); const closeExtras = document.getElementById('closeExtrasPopup'); const hideExtras = () => { extrasPopup.style.display = 'none'; }; closeExtras.addEventListener('click', hideExtras);
            const detailPopup = document.getElementById('itemDetailPopup'); const closeDetail = document.getElementById('closeItemDetailPopup'); const hideDetail = () => { detailPopup.style.display = 'none'; }; closeDetail.addEventListener('click', hideDetail);
			window.addEventListener('click', e => { if (e.target == extrasPopup) hideExtras(); if (e.target == detailPopup) hideDetail(); if (e.target == document.getElementById('screenOverlay')) closeAdvancedSearchModal(); });
            window.addEventListener('keydown', e => { if (e.key === 'Escape') { if (extrasPopup.style.display === 'flex') hideExtras(); if (detailPopup.style.display === 'flex') hideDetail(); if (document.getElementById('advancedSearchModal').classList.contains('visible')) closeAdvancedSearchModal(); } });
            const resultsContainer = document.getElementById('results'); if (resultsContainer) resultsContainer.addEventListener('scroll', resetAllScrolledItems);
            document.body.addEventListener('click', e => { if (!e.target.closest('.result-item')) resetAllScrolledItems(); });
			window.addEventListener('scroll', throttle(resetAllScrolledItems, 100));
			window.addEventListener('resize', debounce(() => { document.querySelectorAll('#results .result-item').forEach(setupScrollControlsForItem); }, 50));
		});
    </script>
</body>
</html>
