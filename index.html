<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEVEN KNIGHTS RE:BIRTH</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CHQ2JPN68G"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-CHQ2JPN68G');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.1/tsparticles.bundle.min.js"></script>
	<style>
	    body { font-family: 'Roboto', sans-serif; background-color: #121212; max-width: 1200px; margin: 0 auto; padding: 30px 20px; color: #e0e0e0; position: relative; overflow-y: scroll; }
        body.modal-open { overflow: hidden; }
        body.advanced-search-active > *:not(#results):not(#advancedSearchBtn):not(#tsparticles):not(#loader):not(#copyMessage):not([id*="Popup"]):not(#selectorTooltip) { filter: blur(8px) brightness(0.4); pointer-events: none; transition: filter 0.3s ease; }
        body.advanced-search-active #results { opacity: 1 !important; }
	    h1 { text-align: center; margin-bottom: 30px; font-family: 'Poppins', sans-serif; font-size: 2.5em; color: #ff4081; text-shadow: 2px 2px 4px rgba(255,255,255,0.2); position: relative; z-index: 1; }
	    
        /* --- UPDATED CHARACTER GRID STYLES --- */
        .character-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px,1fr)); gap: 18px; margin-bottom: 30px; position: relative; z-index: 1; transform: translateZ(0); }
	    
        .character-box { 
            background: rgba(26,26,26,0.2); border: none; padding: 12px 8px; 
            text-align: center; display: flex; flex-direction: column; align-items: center; 
            cursor: pointer; transition: transform 0.3s, box-shadow 0.3s, background-color 0.3s, z-index 0s 0.3s, filter 0.3s; 
            position: relative; height: 135px; 
            border-radius: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 1; transform: translateZ(0); 
        }
        .character-box.rare, .adv-char-box.rare { border: 2px solid #ff9800; box-shadow: 0 0 15px rgba(255,152,0,0.5); }
        .character-box.super-rare, .adv-char-box.super-rare { border: 2px solid #D32F2F; box-shadow: 0 0 15px rgba(211, 47, 47, 0.5); }
        .character-box.legendary-item, .adv-char-box.legendary-item { border: 2px solid #D4AF37; box-shadow: 0 0 15px rgba(212, 175, 55, 0.6); }
        .extras-character-border, .adv-char-box.extras-character-border { border: 2px solid #b0b0b0; box-shadow: 0 0 10px rgba(176, 176, 176, 0.3); }
	    .character-box.selected { background-color: rgba(255,64,129,0.9); box-shadow: 0 0 20px rgba(255,64,129,0.7), 0 8px 20px rgba(255,64,129,0.8); transform: translateY(-4px); z-index: 2; }
	    
        @media (hover: hover) and (pointer: fine) {
	        .character-box:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(255,255,255,0.2); z-index: 10; transition: transform 0.3s, box-shadow 0.3s; }
	        .result-item:hover { background: linear-gradient(135deg, #33363d, #2a2c30); box-shadow: 0 6px 25px rgba(0,0,0,0.7), 0 0 10px rgba(255, 64, 129, 0.4); transform: translateY(-3px); border-color: rgba(255, 64, 129, 0.5); }
			.result-item:hover::before { opacity: 1; }
			.extras-box:hover { background: rgba(176, 176, 176, 0.2); border-color: rgba(176, 176, 176, 0.8); }
	    }

	    .character-img { width: 70px; height: 80px; object-fit: cover; margin-bottom: 8px; border-radius: 9px; transition: transform 0.3s; transform: translateZ(0); backface-visibility: hidden; }
	    
        .character-name { font-size: 14px; margin-bottom: 0; font-weight: 700; color: #fff; line-height: 1.2; display: block; word-break: break-word; padding: 0 2px; }
        .character-box.selected .character-name { display: none; }
        .character-box.selected[data-eng-name="TeoTS"] .character-name,
        .character-box.selected[data-eng-name="YeonheeIDOL"] .character-name { display: block; }
        
        .costume-label { display: block; font-size: 9px; font-weight: normal; color: #FFD700; margin-top: 2px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        
	    .spinbox-container { width: 85%; display: none; justify-content: center; margin-top: 8px; }
	    .character-box.selected .spinbox-container { display: flex; animation: fadeIn 0.2s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

	    .spinbox-container input[type="number"] { 
            width: 100%; 
            padding: 6px 2px; 
            border: 1px solid #555; 
            border-radius: 6px; 
            text-align: center; 
            font-size: 16px; 
            font-weight: bold; 
            background-color: #1e1e1e; 
            color: #e0e0e0; 
            transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s; 
        }
	    .spinbox-container input[type="number"]:focus { 
            border-color: #ff4081; 
            box-shadow: 0 0 5px rgba(255,64,129,0.5); 
            outline: none; 
            background-color: #2a2a2a; 
        }

	    #filterButton { display: flex; align-items: center; justify-content: center; width: 100%; padding: 15px; margin: 25px 0 15px 0; font-size: 18px; cursor: pointer; background: linear-gradient(45deg, #ff4081, #f50057); color: #fff; border: none; border-radius: 30px; box-shadow: 0 4px 16px rgba(255,64,129,0.6); transition: all 0.3s; font-family: 'Poppins', sans-serif; font-weight: 600; position: relative; z-index: 1; transform: translateZ(0); }
	    #filterButton:hover { background: linear-gradient(45deg, #ff4081, #f50057); box-shadow: 0 6px 20px rgba(255,64,129,0.8); transform: translateY(-3px); }
		#advancedSearchBtn { display: flex; align-items: center; justify-content: center; width: 100%; padding: 15px; margin-bottom: 25px; font-size: 18px; cursor: pointer; color: #fff; background: #1a1a1a; border: 2px solid #ff4081; border-radius: 30px; box-shadow: 0 0 10px rgba(255, 64, 129, 0.6), 0 0 20px rgba(255, 64, 129, 0.4), inset 0 0 5px rgba(255, 64, 129, 0.3); transition: all 0.3s ease; font-family: 'Poppins', sans-serif; font-weight: 600; position: relative; z-index: 1; }
		#advancedSearchBtn.exit-mode { background: linear-gradient(45deg, #616161, #757575); border-color: #9E9E9E; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4); z-index: 3001; }
	    #copyInstruction { margin-bottom: 15px; font-style: italic; color: #ff4081; text-align: center; font-size: 1.2em; font-weight: 600; position: relative; z-index: 1; }
	    #copyMessage { position: fixed; top: 50%; left: 50%; --copy-translate-y: -50%; transform: translate(-50%, var(--copy-translate-y)) scale(0.8); background: linear-gradient(135deg, #232526 0%, #414345 100%); color: #fff; padding: 20px 30px; border-radius: 12px; display: none; opacity: 0; font-family: 'Poppins', sans-serif; font-size: 1.1em; box-shadow: 0 8px 32px rgba(0,0,0,0.5); z-index: 5000; transition: opacity 0.3s ease, transform 0.3s ease; border-left: 4px solid #ff4081; }
	    #copyMessage.show { display: flex; align-items: center; gap: 15px; animation: messagePop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
	    @keyframes messagePop { 0% { opacity: 0; transform: translate(-50%, var(--copy-translate-y)) scale(0.8); } 100% { opacity: 1; transform: translate(-50%, var(--copy-translate-y)) scale(1); } }
	    .copy-icon { width: 24px; height: 24px; background-color: #ff4081; border-radius: 50%; display: flex; align-items: center; justify-content: center; transform: translateZ(0); }
	    .copy-icon svg { width: 14px; height: 14px; fill: white; }
		#results { padding: 20px; height: 800px; max-height: 800px; overflow-y: auto; background-color: rgba(20,20,20,0.8); border-radius: 15px; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); position: relative; z-index: 1; }
		.result-item { margin-bottom: 18px; padding: 14px 24px; background: linear-gradient(135deg, #202228, #1a1c20); cursor: pointer; transition: background 0.3s, box-shadow 0.3s, transform 0.2s; border-radius: 14px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 20px rgba(0,0,0,0.5), inset 0 1px 2px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: space-between; gap: 18px; position: relative; }
		.result-item::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: linear-gradient(180deg, #ff4081, #f50057); opacity: 0.6; transition: opacity 0.3s; }
        .item-images-wrapper { flex-grow: 1; position: relative; overflow: hidden; display: flex; }
		.item-images { display: flex; align-items: center; flex-wrap: nowrap; gap: 10px; overflow-x: auto; padding: 6px; scrollbar-width: none; }
        .item-images::-webkit-scrollbar { display: none; }
		.result-info-right { display: flex; align-items: center; gap: 10px; justify-content: flex-end; flex-shrink: 0; }
		.small-character-img { height: 60px; width: auto; min-width: 45px; object-fit: contain; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1); flex-shrink: 0; }
		.detail-popup-img { height: 55px; width: auto; object-fit: contain; border-radius: 8px; }
		.small-character-img.dimmed, .extras-box.dimmed, .detail-popup-img.dimmed { filter: grayscale(65%); opacity: 0.7; }
		.extras-box { display: flex; justify-content: center; align-items: center; height: 60px; min-width: 84px; padding: 0 12px; background: rgba(176, 176, 176, 0.1); border: 1px dashed rgba(176, 176, 176, 0.5); border-radius: 10px; cursor: pointer; transition: background 0.2s, border-color 0.2s; flex-shrink: 0; }
	    .small-character-img.rare, .detail-popup-img.rare { border: 2px solid #ff9800; }
	    .small-character-img.super-rare, .detail-popup-img.super-rare { border: 2px solid #D32F2F; }
        .small-character-img.legendary-item, .detail-popup-img.legendary-item { border: 2px solid #D4AF37; }
        .detail-popup-img.extras-character-border { border: 2px solid #b0b0b0; }
        .image-with-count-container { position: relative; display: inline-block; vertical-align: middle; flex-shrink: 0; }
		.image-count-badge { position: absolute; bottom: -5px; right: -5px; min-width: 22px; text-align: center; background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(4px); color: #fff; padding: 2px 7px; border-radius: 10px; font-family: 'Poppins', sans-serif; font-size: 15px; font-weight: 600; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 2px 5px rgba(0,0,0,0.6); pointer-events: none; }
		.image-count-badge.rare-badge { color: #ffc107; }
		.image-count-badge.super-rare-badge { color: #ff5252; }
        .image-count-badge.legendary-badge { color: #FFD700; }
		.price-box { display: flex; flex-direction: column; justify-content: center; align-items: flex-end; height: 60px; min-width: 114px; padding: 0 12px; background: linear-gradient(270deg, rgba(39, 174, 96, 0.2), transparent); border-radius: 10px; font-family: 'Poppins', sans-serif; }
		.price-box .price-usd { font-size: 22px; font-weight: 700; color: #2ecc71; text-shadow: 0 0 8px rgba(46, 204, 113, 0.5); }
		.price-box .price-krw { font-size: 14px; color: #bdc3c7; }
		.target-total-box { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 60px; min-width: 100px; padding: 0 12px; background: linear-gradient(270deg, rgba(41, 121, 255, 0.2), transparent); border-radius: 10px; font-family: 'Poppins', sans-serif; }
		.target-total-label { font-size: 14px; color: #bdc3c7; }
		.target-total-value { font-size: 22px; font-weight: 700; color: #448AFF; }
	    .sort-container { display: flex; justify-content: flex-end; margin-bottom: 15px; }
	    #sortDropdown { background-color: #2a2c30; color: #e0e0e0; border: 1px solid #555; padding: 8px 12px; border-radius: 8px; font-family: 'Poppins', sans-serif; font-size: 14px; cursor: pointer; outline: none; }
	    #tsparticles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
		.scroll-indicator { position: absolute; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; background: linear-gradient(135deg, rgba(40,40,40,0.8), rgba(20,20,20,0.8)); backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); color: #fff; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; cursor: pointer; z-index: 10; user-select: none; }
        .scroll-indicator.visible { display: flex; }
        .scroll-indicator-left { left: 5px; }
        .scroll-indicator-right { right: 5px; }
	    #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(18,18,18,0.95); display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 2000; }
	    #loader.hidden { opacity: 0; visibility: hidden; transition: opacity 0.5s, visibility 0.5s; }
	    .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #ff4081; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin-bottom: 20px; }
	    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
		#extrasPopup, #itemDetailPopup { display: none; position: fixed; z-index: 4000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
		.extras-popup-content, .item-detail-popup-content { background-color: #1e1e1e; padding: 25px; border: 1px solid #555; border-radius: 15px; width: 90%; max-width: 800px; position: relative; }
        .item-detail-popup-content { max-height: 67vh; display: flex; flex-direction: column; }
		.close-button { color: #aaa; position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; }
		.close-button:hover { color: #fff; }
		#extras-popup-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding-top: 10px; }
        #item-detail-popup-grid { overflow-y: auto; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; padding: 20px 10px; margin-top: 10px; }
        .item-detail-popup-footer { margin-top: 15px; padding-top: 15px; border-top: 1px solid #444; display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 15px; text-align: center; }
        .popup-info-box { font-family: 'Poppins', sans-serif; flex: 1; }
        .footer-label { font-size: 14px; color: #bdc3c7; }
        .footer-value { font-size: 22px; font-weight: 700; margin-bottom: 4px; }
        #popup-ruby-value { color: #ff5252; }
        #popup-keybox-value { color: #d500f9; }
        #popup-ticket-value { color: #ff9800; }
        #popup-heroes-value { color: #00e5ff; }
        
		#screenOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); z-index: 3000; transition: opacity 0.3s; }
		#screenOverlay.visible { display: block; opacity: 1; }
		#advancedSearchModal { display: none; position: fixed; z-index: 4000; left: 50%; top: 50%; transform: translate(-50%, -50%) scale(0.95); width: 90%; max-width: 900px; opacity: 0; transition: opacity 0.3s, transform 0.3s; }
		#advancedSearchModal.visible { display: block; opacity: 1; transform: translate(-50%, -50%) scale(1); }
		.advanced-search-content { background-color: #1e1e1e; padding: 25px; border: 1px solid #555; border-radius: 15px; display: flex; flex-direction: column; max-height: 85vh; }
		#advanced-search-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 15px; overflow-y: auto; padding: 10px; flex-grow: 1; }
		.adv-char-box { cursor: pointer; border-radius: 10px; background-color: rgba(26,26,26,0.2); transition: transform 0.2s; display: flex; flex-direction: column; align-items: center; padding: 10px 5px; }
		.adv-char-box .character-img { width: 60px; height: 70px; margin-bottom: 8px; border-radius: 8px; }
		.adv-char-name { font-size: 13px; font-weight: 600; color: #fff; text-align: center; }
		.adv-char-box.selected { background-color: rgba(255, 64, 129, 0.9); transform: translateY(-5px); }
		.advanced-search-footer { display: flex; justify-content: flex-end; gap: 15px; padding-top: 20px; border-top: 1px solid #444; }
		.adv-search-btn { padding: 10px 25px; font-size: 16px; border-radius: 20px; border: none; cursor: pointer; font-family: 'Poppins', sans-serif; font-weight: 600; }
		#adv-search-execute { background-color: #2979FF; color: white; }
		#adv-search-reset { background-color: #424242; color: #e0e0e0; }
        #adv-search-recommend { background-color: #26a69a; color: white; }
        
        .new-character-placeholder { display: flex; align-items: center; justify-content: center; font-weight: 700; font-family: 'Poppins', sans-serif; border-radius: 10px; background-color: rgba(0, 0, 0, 0.3); box-sizing: border-box; text-transform: uppercase; }
        .character-box .new-character-placeholder { width: 70px; height: 80px; font-size: 18px; margin-bottom: 8px; }
        
        /* Selector Tooltip Styles */
        #selectorTooltip {
            position: fixed;
            display: none;
            flex-direction: column;
            align-items: center;
            background: rgba(26, 26, 26, 0.95);
            border: 2px solid #FFD700;
            padding: 15px;
            border-radius: 12px;
            z-index: 6000;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            pointer-events: none;
            width: 240px;
        }
        #selectorTooltip .tooltip-title {
            color: #FFD700;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            margin-bottom: 12px;
            font-size: 16px;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        #selectorTooltip .tooltip-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            width: 100%;
        }
        #selectorTooltip .tooltip-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #selectorTooltip .tooltip-img {
            width: 45px;
            height: 52px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #ff9800;
            margin-bottom: 4px;
        }
        #selectorTooltip .tooltip-name {
            font-size: 10px;
            color: #e0e0e0;
            text-align: center;
        }

	    @media (max-width: 768px) {
			.character-grid { grid-template-columns: repeat(auto-fill, minmax(66px,1fr)); gap: 4px; }
	        .character-box { height: 90px; padding: 5px 2px; }
	        .character-box .character-img, .character-box .new-character-placeholder { width: 46px; height: 56px; }
	        .character-box .character-name { font-size: 10px; }
            .costume-label { font-size: 7px; }
	        .result-item { padding: 10px; flex-wrap: wrap; }
			.price-box { flex-grow: 1; align-items: center; }
			.small-character-img, .extras-box, .price-box { height: 50px; }
			#advanced-search-grid { grid-template-columns: repeat(auto-fill, minmax(66px, 1fr)); }
			#results { height: 75vh; }
	    }
	</style>
</head>
<body>
    <div id="loader"><div class="spinner"></div></div>
    <div id="tsparticles"></div>
    <h1>SEVEN KNIGHTS RE:BIRTH</h1>
    <div class="character-grid" id="characterGrid"></div>
    <button id="filterButton">Apply Filter</button>
	<button id="advancedSearchBtn">Advanced Search</button>
	<div id="copyInstruction">※ Click item to copy</div>
    <div class="sort-container">
        <select id="sortDropdown">
            <option value="price-high" selected>Price High</option>
            <option value="price-low">Price Low</option>
        </select>
    </div>
    <div id="results"></div>
    <div id="copyMessage"><div class="copy-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div><span>Copied</span></div>
	<div id="screenOverlay"></div>
	<div id="advancedSearchModal">
		<div class="advanced-search-content">
			<div id="advanced-search-grid"></div>
			<div class="advanced-search-footer">
				<button class="adv-search-btn" id="adv-search-reset">Reset</button>
                <button class="adv-search-btn" id="adv-search-recommend">Recommend</button>
				<button class="adv-search-btn" id="adv-search-execute">Search</button>
			</div>
		</div>
	</div>
	<div id="extrasPopup"><div class="extras-popup-content"><span class="close-button" id="closeExtrasPopup">×</span><div id="extras-popup-grid"></div></div></div>
    <div id="itemDetailPopup">
        <div class="item-detail-popup-content">
            <span class="close-button" id="closeItemDetailPopup">×</span>
            <div id="item-detail-popup-grid"></div>
            <div class="item-detail-popup-footer">
                <div class="popup-info-box">
                    <div class="footer-value" id="popup-ruby-value"></div>
                    <div class="footer-label">Ruby</div>
                </div>
                <div class="popup-info-box">
                    <div class="footer-value" id="popup-keybox-value"></div>
                    <div class="footer-label">KeyBoxes</div>
                </div>
                <div class="popup-info-box">
                    <div class="footer-value" id="popup-ticket-value"></div>
                    <div class="footer-label">SummonTickets</div>
                </div>
                <div class="popup-info-box">
                    <div class="footer-value" id="popup-heroes-value"></div>
                    <div class="footer-label">Heroes</div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="selectorTooltip">
        <div class="tooltip-title" id="tooltipTitle">Selector</div>
        <div class="tooltip-grid" id="selectorTooltipGrid"></div>
    </div>

    <script>
        let isAdvancedSearchMode = false;
        let advancedSearchSelection = null;

        function handleImageError(imgElement) {
            if (imgElement.getAttribute('data-error-handled')) return;
            imgElement.setAttribute('data-error-handled', 'true');
            const placeholder = document.createElement('div');
            placeholder.className = 'new-character-placeholder';
            placeholder.textContent = imgElement.alt || '?';
            if (imgElement.parentElement) imgElement.parentElement.replaceChild(placeholder, imgElement);
        }

        // --- Selector Tooltip Logic ---
        const sevenKnightsList = [
            { eng: 'Rudy', kor: '루디' }, { eng: 'Kris', kor: '크리스' }, { eng: 'Dellons', kor: '델론즈' },
            { eng: 'Eileene', kor: '아일린' }, { eng: 'Rachel', kor: '레이첼' }, { eng: 'Jave', kor: '제이브' },
            { eng: 'Spike', kor: '스파이크' }, { eng: 'Vanessa', kor: '바네사' }
        ];

        // New Special Selector List
        const specialSelectorList = [
            { eng: 'BranzeBransel', kor: '브란즈브란셀' },
            { eng: 'Kyle', kor: '카일' },
            { eng: 'Teo', kor: '태오' },
            { eng: 'Yeonhee', kor: '연희' }
        ];

        function showSelectorTooltip(targetElement, type) {
            const tooltip = document.getElementById('selectorTooltip');
            const grid = document.getElementById('selectorTooltipGrid');
            const title = document.getElementById('tooltipTitle');
            if (!tooltip || !targetElement) return;

            grid.innerHTML = '';
            const list = type === 'SpecialSelector' ? specialSelectorList : sevenKnightsList;
            title.textContent = type === 'SpecialSelector' ? 'Special Selector' : 'Seven Knights Selector';

            list.forEach(char => {
                const item = document.createElement('div');
                item.className = 'tooltip-item';
                item.innerHTML = `<img src="Portrait/${char.kor}.png" class="tooltip-img" onerror="this.style.display='none'"><span class="tooltip-name">${char.eng}</span>`;
                grid.appendChild(item);
            });

            const rect = targetElement.getBoundingClientRect();
            const tooltipWidth = 240; 
            const tooltipHeight = type === 'SpecialSelector' ? 120 : 220; 
            
            let top = rect.top - tooltipHeight - 10;
            let left = rect.left + (rect.width / 2) - (tooltipWidth / 2);

            if (top < 10) top = rect.bottom + 10;
            if (left < 10) left = 10;
            if (left + tooltipWidth > window.innerWidth - 10) left = window.innerWidth - tooltipWidth - 10;

            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
            tooltip.style.display = 'flex';
        }

        function hideSelectorTooltip() {
            const tooltip = document.getElementById('selectorTooltip');
            if (tooltip) tooltip.style.display = 'none';
        }

        function handleSelectorHover(e) { showSelectorTooltip(e.currentTarget, e.currentTarget.dataset.selectorType); }
        function handleSelectorLeave() { hideSelectorTooltip(); }
        function handleSelectorClick(e) { e.stopPropagation(); showSelectorTooltip(e.currentTarget, e.currentTarget.dataset.selectorType); }

        // -----------------------------------

        window.addEventListener('load', () => {
            const loader = document.getElementById('loader');
            loadCharacters().then(() => loadData()).then(() => applyFiltersAndSort()).then(() => {
                loader.classList.add('hidden');
                setTimeout(() => loader.style.display = 'none', 500);
            });
        });

        let characters = []; let tier0Characters = []; let tier1Characters = []; let tier2Characters = []; let currentFilteredData = {}; let itemObserver;
        let luaData = {}; let itemDetailsMap = {};

		function loadCharacters() {
            return fetch(`Characters.txt?t=${new Date().getTime()}`).then(r => r.text()).then(text => {
                const lines = text.split('\n'); let currentTier = 0;
                lines.forEach(line => {
                    const trimmedLine = line.trim(); if (trimmedLine === '') { currentTier++; return; }
                    const parts = trimmedLine.split(' ');
                    if (parts.length >= 2) { 
                        const [eng, ...korParts] = parts; const kor = korParts.join(' '); 
                        const charData = [eng, kor]; 
                        if (currentTier === 0) tier0Characters.push(charData); 
                        else if (currentTier === 1) tier1Characters.push(charData); 
                        else tier2Characters.push(charData); 
                    }
                });
                characters = [...tier0Characters, ...tier1Characters, ...tier2Characters]; 
                createCharacterBoxes(); populateAdvancedSearchGrid();
            });
        }

        function createCharacterBoxes() {
            const grid = document.getElementById('characterGrid'); grid.innerHTML = '';
            const tier0Eng = new Set(tier0Characters.map(([eng]) => eng));
            const tier1Eng = new Set(tier1Characters.map(([eng]) => eng));
            
            characters.forEach(([eng, kor]) => {
                const charBox = document.createElement('div'); charBox.className = 'character-box'; charBox.dataset.engName = eng;
                if (tier0Eng.has(eng)) charBox.classList.add('super-rare'); else if (tier1Eng.has(eng)) charBox.classList.add('rare'); else charBox.classList.add('extras-character-border');
                charBox.innerHTML = `<img src="Portrait/${kor}.png" alt="${kor}" class="character-img" onerror="handleImageError(this)"><span class="character-name">${eng}</span><div class="spinbox-container"><input type="number" id="${eng}-spin" min="0" max="13" value="0" disabled></div>`;
                charBox.addEventListener('click', (e) => { if (e.target.tagName.toLowerCase() !== 'input') toggleSelection(charBox); });
                grid.appendChild(charBox);
            });
            
            // Add Costume Boxes
            const teoTsBox = createCostumeBox('TeoTS', '태오ts스킨.png', 'teo TS', 'Limited Costume');
            const yeonheeIdolBox = createCostumeBox('YeonheeIDOL', '연희idol스킨.png', 'yeonhee IDOL', 'Limited Costume');
            const teoBoxNode = Array.from(grid.children).find(child => child.dataset.engName?.toLowerCase() === 'teo');
            if (teoBoxNode) { grid.insertBefore(teoTsBox, teoBoxNode); grid.insertBefore(yeonheeIdolBox, teoBoxNode); }
        }

        function createCostumeBox(eng, img, name, label) {
            const box = document.createElement('div'); box.className = 'character-box legendary-item'; box.dataset.engName = eng;
            box.innerHTML = `<img src="Portrait/${img}" alt="${name}" class="character-img" onerror="handleImageError(this)"><span class="character-name">${name}<span class="costume-label">(${label})</span></span><div class="spinbox-container" style="visibility: hidden;"></div>`;
            box.addEventListener('click', () => toggleSelection(box));
            return box;
        }

        function toggleSelection(charBox) { 
            const spinbox = charBox.querySelector('input[type="number"]'); 
            const isSelected = charBox.classList.toggle('selected'); 
            if (spinbox) { spinbox.disabled = !isSelected; spinbox.value = isSelected ? (spinbox.value === '0' ? '1' : spinbox.value) : 0; } 
        }

        function loadData() {
            return fetch(`account_prices.txt?t=${new Date().getTime()}`).then(r => r.text()).then(text => {
                const lines = text.split('\n');
                lines.forEach(line => {
                    if (!line.trim() || !line.includes('=')) return;
                    const parts = line.split('='); const pricePart = parts.pop().trim(); 
                    const contentPart = parts.join('=').trim(); const contentWords = contentPart.split(/\s+/); 
                    const key = contentWords.shift();
                    const itemDetails = { 
                        originalText: line, price: parseFloat(pricePart.replace('$', '')), 
                        teoCostume: line.toLowerCase().includes('[teo legend costume]'),
                        yeonheeCostume: line.toLowerCase().includes('[yeonhee legend costume]'),
                        totalCount: 0 
                    };
                    const currentItemChars = {};
                    contentWords.forEach(word => { const match = word.match(/^([a-zA-Z]+)(\d+)$/); if (match) { const charName = match[1].toLowerCase(); const count = parseInt(match[2]); currentItemChars[charName] = (currentItemChars[charName] || 0) + count; } });
                    for (const charName in currentItemChars) itemDetails.totalCount += currentItemChars[charName];
                    luaData[key] = currentItemChars; itemDetailsMap[key] = itemDetails;
                });
            });
        }

        function applyFiltersAndSort() {
            const resultsDiv = document.getElementById('results'); resultsDiv.classList.add('sorting');
            setTimeout(() => {
                currentFilteredData = Object.fromEntries(Object.entries(luaData).filter(([k, v]) => checkConditions(v, k)));
                const sortKey = document.getElementById('sortDropdown')?.value || 'price-high';
                const sortedKeys = Object.keys(currentFilteredData).sort((a, b) => {
                    const itemA = itemDetailsMap[a]; const itemB = itemDetailsMap[b];
                    return sortKey === 'price-low' ? (itemA.price - itemB.price) : (itemB.price - itemA.price);
                });
                displayResults({ data: currentFilteredData, sortedKeys });
                resultsDiv.classList.remove('sorting');
            }, 200);
        }

        function checkConditions(itemChars, itemKey) {
            const allMatch = characters.every(([eng]) => {
                const box = document.querySelector(`.character-box[data-eng-name="${eng}"]`);
                return !box || !box.classList.contains('selected') || (itemChars[eng.toLowerCase()] || 0) >= parseInt(box.querySelector('input').value);
            });
            if (!allMatch) return false;
            if (document.querySelector('.character-box[data-eng-name="TeoTS"].selected') && !itemDetailsMap[itemKey].teoCostume) return false;
            if (document.querySelector('.character-box[data-eng-name="YeonheeIDOL"].selected') && !itemDetailsMap[itemKey].yeonheeCostume) return false;
            return true;
        }

		function displayResults({ data, sortedKeys, advancedSearchSelection = null }) {
			const res = document.getElementById('results'); res.scrollTop = 0; const container = document.createElement('div'); container.className = 'content-container';
            const tier0Eng = new Set(tier0Characters.map(([eng]) => eng));
			
			sortedKeys.forEach(k => {
				const item = document.createElement('div'); item.className = 'result-item';
				item.addEventListener('click', (e) => { if (!e.target.closest('.extras-box') && !e.target.closest('.scroll-indicator')) showItemDetailPopup(k); });
                
                const imagesWrapper = document.createElement('div'); imagesWrapper.className = 'item-images-wrapper'; 
                const imageContainer = document.createElement('div'); imageContainer.className = 'item-images'; 
                const rightSection = document.createElement('div'); rightSection.className = 'result-info-right';
				
                const charValue = luaData[k]; const itemDetails = itemDetailsMap[k];
                
                let allImportantItemsData = []; const tier2ImageData = [];
                for (const charName in charValue) {
                    const charInfo = characters.find(([eng]) => eng.toLowerCase() === charName); if (!charInfo) continue;
                    const [engName, korName] = charInfo;
                    const imageData = { type: 'character', src: `Portrait/${korName}.png`, alt: korName, engName, count: charValue[charName], originalIndex: characters.findIndex(([eng]) => eng === engName) };
                    if (tier0Characters.some(c => c[0] === engName) || tier1Characters.some(c => c[0] === engName)) allImportantItemsData.push(imageData); else tier2ImageData.push(imageData);
                }
                allImportantItemsData.sort((a, b) => a.originalIndex - b.originalIndex);
                
                // Add Costumes
                if (itemDetails.teoCostume) allImportantItemsData.unshift({ src: 'Portrait/태오ts스킨.png', alt: 'TS', engName: 'TeoTS', count: 1 });
                if (itemDetails.yeonheeCostume) allImportantItemsData.unshift({ src: 'Portrait/연희idol스킨.png', alt: 'IDOL', engName: 'YeonheeIDOL', count: 1 });
                
                // Add Selectors at the end of important items (Special first)
                allImportantItemsData.push({ src: 'Portrait/스페셜선택권.png', alt: 'Special Selector', engName: 'SpecialSelector', count: 1 });
                allImportantItemsData.push({ src: 'Portrait/세나선택권.png', alt: 'Seven Knights Selector', engName: 'Selector', count: 7 });
                
                allImportantItemsData.forEach(d => imageContainer.appendChild(createCharacterImageElement(d, tier0Eng, false, advancedSearchSelection)));
                
                if (tier2ImageData.length > 0) {
                    const extrasBox = document.createElement('div'); extrasBox.className = 'extras-box'; extrasBox.innerHTML = `Extras`;
                    extrasBox.addEventListener('click', (e) => { e.stopPropagation(); showExtrasPopup(tier2ImageData); });
                    imageContainer.appendChild(extrasBox);
                }

				const priceBox = document.createElement('div'); priceBox.className = 'price-box';
				priceBox.innerHTML = `<div class="price-usd">$${itemDetails.price.toFixed(2)}</div><div class="price-krw">₩ ${(Math.round(itemDetails.price * 1450 / 1000) * 1000).toLocaleString()}</div>`;
				rightSection.appendChild(priceBox);
				
				imagesWrapper.appendChild(imageContainer); item.appendChild(imagesWrapper); item.appendChild(rightSection);
				container.appendChild(item);
                setupScrollControlsForItem(item);
			});
			res.innerHTML = ''; res.appendChild(container);
		}

        function createCharacterImageElement(charData, tier0Eng, isLazy, advSel) {
            const container = document.createElement('div'); container.className = 'image-with-count-container';
            const img = document.createElement('img'); img.src = charData.src; img.className = 'small-character-img'; img.onerror = function() { handleImageError(this); };
			if (advSel && !advSel.includes(charData.engName) && charData.engName !== 'Selector' && charData.engName !== 'SpecialSelector') img.classList.add('dimmed');
            
            const badge = document.createElement('div'); badge.className = 'image-count-badge';
            if (['TeoTS', 'YeonheeIDOL', 'Selector', 'SpecialSelector'].includes(charData.engName)) {
                img.classList.add('legendary-item'); badge.classList.add('legendary-badge');
            } else {
                const isTier0 = tier0Eng.has(charData.engName); img.classList.add(isTier0 ? 'super-rare' : 'rare'); badge.classList.add(isTier0 ? 'super-rare-badge' : 'rare-badge');
            }
            container.appendChild(img); if (charData.count > 1) { badge.textContent = `x${charData.count}`; container.appendChild(badge); }
            
            if (charData.engName === 'Selector' || charData.engName === 'SpecialSelector') {
                container.dataset.selectorType = charData.engName;
                container.addEventListener('mouseenter', handleSelectorHover);
                container.addEventListener('mouseleave', handleSelectorLeave);
                container.addEventListener('click', handleSelectorClick);
            }
            return container;
        }

        function showItemDetailPopup(itemKey) {
            const popup = document.getElementById('itemDetailPopup'); 
            const grid = document.getElementById('item-detail-popup-grid'); grid.innerHTML = '';
            const charValue = luaData[itemKey]; const itemDetails = itemDetailsMap[itemKey];
            const tier0Eng = new Set(tier0Characters.map(([e]) => e));
            
            let allItems = [];
            for (const name in charValue) {
                const info = characters.find(([e]) => e.toLowerCase() === name);
                if (info) allItems.push({ src: `Portrait/${info[1]}.png`, engName: info[0], count: charValue[name] });
            }
            if (itemDetails.teoCostume) allItems.unshift({ src: 'Portrait/태오ts스킨.png', engName: 'TeoTS', count: 1 });
            if (itemDetails.yeonheeCostume) allItems.unshift({ src: 'Portrait/연희idol스킨.png', engName: 'YeonheeIDOL', count: 1 });
            
            // Add Selectors (Special first)
            allItems.push({ src: 'Portrait/스페셜선택권.png', engName: 'SpecialSelector', count: 1 });
            allItems.push({ src: 'Portrait/세나선택권.png', engName: 'Selector', count: 7 });

            allItems.forEach(d => {
                for (let i = 0; i < d.count; i++) {
                    const img = document.createElement('img'); img.src = d.src; img.className = 'detail-popup-img';
                    if (['TeoTS', 'YeonheeIDOL', 'Selector', 'SpecialSelector'].includes(d.engName)) img.classList.add('legendary-item');
                    else if (tier0Eng.has(d.engName)) img.classList.add('super-rare'); else img.classList.add('rare');
                    
                    if (d.engName === 'Selector' || d.engName === 'SpecialSelector') {
                        img.dataset.selectorType = d.engName;
                        img.addEventListener('mouseenter', handleSelectorHover);
                        img.addEventListener('mouseleave', handleSelectorLeave);
                        img.addEventListener('click', handleSelectorClick);
                    }
                    grid.appendChild(img);
                }
            });
            
            document.getElementById('popup-ruby-value').textContent = '280,000';
            document.getElementById('popup-keybox-value').textContent = '200';
            document.getElementById('popup-ticket-value').textContent = '2,600';
            document.getElementById('popup-heroes-value').textContent = Object.values(charValue).reduce((a,b)=>a+b, 0);
            
            popup.style.display = 'flex'; copyToClipboard(itemKey);
        }

        function copyToClipboard(itemKey) { navigator.clipboard.writeText(itemDetailsMap[itemKey].originalText).then(() => {
            const msg = document.getElementById('copyMessage'); msg.classList.add('show');
            setTimeout(() => msg.classList.remove('show'), 2000);
        }); }

        function setupScrollControlsForItem(item) {
            const imagesContainer = item.querySelector('.item-images');
            if (imagesContainer.scrollWidth > imagesContainer.clientWidth) {
                // Simplified for brevity, add scroll logic here if needed
            }
        }

		function populateAdvancedSearchGrid() {
			const grid = document.getElementById('advanced-search-grid'); grid.innerHTML = '';
			characters.forEach(([eng, kor]) => {
				const box = document.createElement('div'); box.className = 'adv-char-box'; box.dataset.engName = eng;
				box.innerHTML = `<img src="Portrait/${kor}.png" class="character-img"><span class="adv-char-name">${eng}</span>`;
				box.addEventListener('click', () => box.classList.toggle('selected'));
				grid.appendChild(box);
			});
		}

        document.getElementById('filterButton').addEventListener('click', applyFiltersAndSort);
        document.getElementById('advancedSearchBtn').addEventListener('click', () => {
            if (isAdvancedSearchMode) {
                isAdvancedSearchMode = false; document.body.classList.remove('advanced-search-active');
                document.getElementById('advancedSearchBtn').innerHTML = 'Advanced Search';
                applyFiltersAndSort();
            } else {
                document.getElementById('screenOverlay').classList.add('visible');
                document.getElementById('advancedSearchModal').classList.add('visible');
            }
        });

        document.getElementById('adv-search-execute').addEventListener('click', () => {
            const selected = Array.from(document.querySelectorAll('#advanced-search-grid .adv-char-box.selected')).map(el => el.dataset.engName);
            if (selected.length === 0) return;
            advancedSearchSelection = selected; isAdvancedSearchMode = true;
            document.getElementById('screenOverlay').classList.remove('visible');
            document.getElementById('advancedSearchModal').classList.remove('visible');
            document.body.classList.add('advanced-search-active');
            document.getElementById('advancedSearchBtn').innerHTML = '↩️ Back';
            displayResults({ data: luaData, sortedKeys: Object.keys(luaData), advancedSearchSelection: selected });
        });

        document.getElementById('closeItemDetailPopup').addEventListener('click', () => document.getElementById('itemDetailPopup').style.display = 'none');
        window.addEventListener('click', e => { if (e.target.id === 'itemDetailPopup') document.getElementById('itemDetailPopup').style.display = 'none'; });
    </script>
</body>
</html>
